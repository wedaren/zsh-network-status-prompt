# 需求文档：Zsh 终端网络状态提示插件

## 1. 项目背景与目标

在日常开发中，尤其是在需要频繁切换网络环境（如家庭、公司、VPN）的场景下，开发者经常需要快速了解当前终端的网络配置状态。关键信息包括：是否正在使用代理服务器，以及是否能成功连接到外部关键服务（如 Google、GitHub 等）。

本项目旨在开发一个 Zsh 插件，将这些关键的网络状态信息以直观、简洁的方式直接集成到 Zsh 的命令提示符 (Prompt) 中，从而提高开发效率，减少因网络问题导致的不必要的时间浪费。


## 2. 核心功能需求

### 2.1. 代理状态检测
- **功能描述**：插件必须能够检测当前 Shell 环境是否配置了代理。
- **验收标准**：
    - 能够正确识别 `http_proxy`, `https_proxy`, `all_proxy` (大小写不敏感) 等环境变量的设置。
    - 如果检测到任何代理环境变量被设置，则将代理状态标记为"开启"。
    - 如果未检测到任何代理环境变量，则标记为"关闭"。

### 2.2. 外部网络连通性测试
- **功能描述**：插件需要能测试对一个或多个预定义外部关键服务的 HTTP/HTTPS 连通性。
- **验收标准**：
    - 默认测试目标为 `www.google.com`。
    - 必须使用非 ICMP 协议的方式进行测试（如 `curl` 的 `HEAD` 请求），以避免防火墙干扰。
    - 测试必须设置合理的超时时间（例如，2-3秒），以防止在网络不佳时终端被长时间卡住。
    - 根据命令的退出码 (`$?`) 来判断连接是否成功。

### 2.3. 状态可视化展示
- **功能描述**：将检测到的代理状态和网络连通性状态，以类似于 `robbyrussell` 主题中 Git 状态的文本和颜色风格，整合并显示在 Zsh 提示符中。
- **验收标准**：
    - **显示格式**：采用 `net:(<status> <proxy_indicator>)` 的格式。
    - **状态文本与颜色**：
        - **网络连接正常时**：`<status>` 为 `online`，整体显示为绿色。
        - **网络连接异常时**：`<status>` 为 `offline`，整体显示为红色。
    - **代理指示器**：
        - **代理开启时**：`<proxy_indicator>` 为 `P`。
        - **代理关闭时**：`<proxy_indicator>` 为空，不显示任何字符。
    - **最终效果示例**：
        - 网络正常，代理开启: `net:(online P)` (绿色)
        - 网络正常，代理关闭: `net:(online)` (绿色)
        - 网络异常，代理开启: `net:(offline P)` (红色)
        - 网络异常，代理关闭: `net:(offline)` (红色)
    - **位置**：默认将状态显示在右侧提示符 (`RPROMPT`)，但应提供选项允许用户配置到左侧 (`PROMPT`)。

## 3. 非功能性需求

### 3.1. 高性能
- **功能描述**：插件的运行绝不能对 Zsh 的启动速度和命令执行的响应速度造成可感知的延迟。
- **验收标准**：
    - **异步加载**：插件核心逻辑应使用 `autoload` 机制。
    - **缓存机制**：网络状态检测结果必须被缓存。只有当缓存过期（例如，超过5分钟）或被强制刷新时，才执行实际的网络请求。在缓存有效期内，直接从缓存读取状态，响应时间应接近于零。

### 3.2. 易用性与可配置性
- **功能描述**：插件应易于安装和配置。
- **验收标准**：
    - **插件化**：遵循 Oh My Zsh 等主流插件管理器的标准结构，方便用户通过插件列表一键启用。
    - **文档清晰**：提供详细的 `README.md`，包括安装、用法和配置说明。

### 3.3. 健壮性与兼容性
- **功能描述**：插件应在常见的环境下稳定运行。
- **验收标准**：
    - **依赖处理**：明确声明对 `curl` 等外部命令的依赖，并在插件加载时进行检查。
    - **跨平台**：主要兼容 macOS 和主流 Linux 发行版。

## 4. 实现思路与技术选型
- **语言**: Zsh Shell 脚本。
- **核心技术**:
    - 通过检查环境变量 (`$http_proxy`, etc.) 判断代理。
    - 使用 `curl -s --head --connect-timeout 2 [URL]` 进行网络探测。
    - 使用 Zsh 的 `precmd_functions` 或 `PROMPT` 变量来动态更新提示符。
    - 使用临时文件 (`/tmp` 或 `$TMPDIR`) 实现缓存，通过 `stat` 命令获取文件修改时间来判断缓存是否过期。
- **工程化**:
    - 项目使用 Git 进行版本控制。
    - 最终成果将打包成一个独立的 Zsh 插件。
